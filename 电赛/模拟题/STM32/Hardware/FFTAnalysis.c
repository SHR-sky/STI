#include "FFTAnalysis.h"

short ADC_Value[SAMPLE_NODE_NUM] = {0, 2167, -3660, 4014, -3120, 1255, 1000, -2945, 3973, -3765, 2386, -265, -1938, 3539, -4039, 3282, -1505, -741, 2756, -3914, 3854, -2595, 529, 1702, -3403, 4046, -3430, 1748, 479, -2556, 3838, -3927, 2793, -791, -1457, 3252, -4036, 3564, -1983, -214, 2345, -3746, 3982, -2979, 1049, 1207, -3087, 4008, -3681, 2210, -51, -2124, 3638, -4020, 3152, -1303, -951, 2909, -3963, 3784, -2427, 316, 1894, -3514, 4042, -3312, 1552, 691, -2719, 3901, -3869, 2634, -580, -1655, 3375, -4045, 3457, -1793, -428, 2517, -3822, 3939, -2830, 841, 1410, -3222, 4032, -3587, 2027, 164, -2304, 3727, -3991, 3013, -1098, -1158, 3054, -4001, 3702, -2252, 102, 2081, -3616, 4026, -3184, 1351, 901, -2874, 3952, -3801, 2468, -367, -1849, 3489, -4044, 3341, -1598, -641, 2681, -3887, 3884, -2673, 630, 1609, -3347, 4044, -3483, 1839, 378, -2477, 3805, -3950, 2866, -891, -1362, 3191, -4027, 3611, -2071, -113, 2262, -3707, 3999, -3047, 1147, 1109, -3021, 3993, -3722, 2294, -152, -2037, 3592, -4031, 3215, -1399, -852, 2838, -3941, 3818, -2508, 417, 1803, -3463, 4045, -3369, 1645, 591, -2643, 3873, -3898, 2711, -680, -1562, 3318, -4042, 3509, -1884, -327, 2436, -3787, 3961, -2902, 940, 1314, -3159, 4022, -3633, 2114, 62, -2219, 3686, -4006, 3080, -1196, -1060, 2987, -3984, 3742, -2336, 203, 1993, -3569, 4035, -3246, 1447, 802, -2801, 3929, -3835, 2548, -468, -1758, 3436, -4046, 3397, -1691, -540, 2604, -3858, 3911, -2748, 730, 1515, -3289, 4040, -3534, 1929, 276, -2395, 3769, -3971, 2937, -989, -1266, 3127, -4016, 3655, -2158, -11, 2177, -3665, 4013, -3113, 1244, 1011, -2952, 3975, -3761, 2377, -254, -1948, 3545, -4038, 3276, -1494, -752, 2764, -3917, 3851, -2587, 518, 1712, -3409, 4046, -3424, 1737, 490, -2565, 3842, -3924, 2785, -780, -1468, 3259, -4036, 3558, -1973, -226, 2354, -3751, 3980, -2972, 1039, 1217, -3095, 4009, -3677, 2200, -40, -2134, 3643, -4019, 3145, -1293, -962, 2917, -3965, 3780, -2418, 305, 1904, -3520, 4041, -3305, 1541, 702, -2727, 3904, -3866, 2626, -569, -1665, 3381, -4045, 3451, -1783, -439, 2525, -3826, 3936, -2822, 830, 1420, -3228, 4033, -3582, 2017, 175, -2313, 3731, -3989, 3006, -1088, -1169, 3062, -4002, 3698, -2243, 90, 2090, -3621, 4025, -3177, 1341, 912, -2882, 3955, -3797, 2459, -355, -1859, 3494, -4043, 3334, -1588, -652, 2689, -3890, 3881, -2664, 619, 1619, -3353, 4044, -3477, 1829, 389, -2485, 3809, -3947, 2858, -880, -1372, 3198, -4028, 3605, -2061, -124, 2271, -3711, 3997, -3040, 1137, 1120, -3028, 3994, -3718, 2285, -141, -2046, 3598, -4030, 3208, -1389, -863, 2846, -3944, 3815, -2499, 406, 1813, -3469, 4045, -3363, 1635, 602, -2651, 3876, -3895, 2702, -669, -1572, 3324, -4043, 3503, -1874, -338, 2445, -3791, 3958, -2894, 929, 1325, -3166, 4023, -3628, 2105, 73, -2229, 3691, -4005, 3073, -1185, -1071, 2994, -3986, 3738, -2327, 192, 2002, -3574, 4034, -3239, 1436, 813, -2809, 3932, -3831, 2539, -457, -1768, 3442, -4046, 3391, -1681, -551, 2613, -3861, 3908, -2740, 719, 1525, -3295, 4040, -3528, 1919, 288, -2404, 3773, -3969, 2929, -979, -1276, 3134, -4017, 3650, -2148, -22, 2186, -3670, 4012, -3106, 1234, 1022, -2960, 3977, -3757, 2368, -243, -1958, 3550, -4037, 3269, -1484, -763, 2773, -3920, 3847, -2578, 507, 1722, -3415, 4046, -3418, 1727, 501, -2574, 3845, -3921, 2777, -769, -1478, 3265, -4037, 3553, -1963, -237, 2363, -3755, 3978, -2964, 1028, 1228, -3102, 4011, -3672, 2191, -28, -2143, 3648, -4018, 3138, -1282, -973, 2925, -3967, 3776, -2409, 294, 1913, -3525, 4040, -3299, 1531, 713, -2735, 3907, -3863, 2617, -557, -1676, 3388, -4046, 3445, -1773, -451, 2534, -3829, 3933, -2814, 819, 1431, -3235, 4033, -3577, 2008, 186, -2322, 3735, -3987, 2998, -1077, -1179, 3069, -4004, 3693, -2234, 79, 2100, -3626, 4024, -3170, 1330, 923, -2890, 3957, -3794, 2450, -344, -1868, 3500, -4043, 3328, -1578, -663, 2698, -3893, 3878, -2656, 608, 1629, -3359, 4045, -3472, 1819, 400, -2494, 3813, -3945, 2850, -869, -1383, 3204, -4029, 3600, -2052, -135, 2280, -3716, 3995, -3032, 1126, 1131, -3036, 3996, -3714, 2276, -130, -2056, 3603, -4029, 3201, -1378, -874, 2854, -3946, 3811, -2490, 395, 1823, -3474, 4045, -3357, 1625, 613, -2660, 3879, -3892, 2694, -658, -1583, 3331, -4043, 3497, -1864, -349, 2454, -3795, 3956, -2886, 918, 1335, -3173, 4024, -3623, 2095, 84, -2238, 3695, -4003, 3066, -1175, -1082, 3002, -3988, 3734, -2318, 181, 2012, -3579, 4033, -3232, 1426, 824, -2817, 3935, -3828, 2530, -446, -1778, 3448, -4046, 3385, -1671, -563, 2621, -3864, 3905, -2732, 708, 1536, -3302, 4041, -3523, 1909, 299, -2413, 3777, -3966, 2921, -968, -1287, 3141, -4019, 3646, -2139, -34, 2195, -3674, 4010, -3099, 1223, 1033, -2967, 3979, -3753, 2359, -232, -1968, 3555, -4037, 3262, -1473, -774, 2781, -3922, 3844, -2570, 496, 1732, -3421, 4046, -3412, 1717, 512, -2582, 3849, -3918, 2769, -758, -1488, 3272, -4038, 3547, -1954, -248, 2372, -3759, 3976, -2956, 1017, 1239, -3109, 4012, -3667, 2182, -17, -2152, 3653, -4017, 3131, -1272, -984, 2933, -3969, 3772, -2400, 282, 1923, -3531, 4040, -3292, 1521, 724, -2744, 3910, -3859, 2609, -546, -1686, 3394, -4046, 3439, -1763, -462, 2543, -3833, 3931, -2806, 808, 1441, -3242, 4034, -3572, 1998, 197, -2331, 3740, -3985, 2991, -1066, -1190, 3076, -4005, 3689, -2224, 68, 2109, -3631, 4022, -3163, 1320, 934, -2897, 3959, -3790, 2441, -333, -1878, 3506, -4042, 3322, -1568, -674, 2706, -3896, 3874, -2647, 597, 1639, -3366, 4045, -3466, 1809, 411, -2503, 3816, -3942, 2842, -858, -1393, 3211, -4030, 3595, -2042, -146, 2289, -3720, 3994, -3025, 1115, 1141, -3043, 3998, -3709, 2267, -119, -2066, 3608, -4028, 3194, -1368, -885, 2862, -3949, 3807, -2481, 384, 1833, -3480, 4044, -3350, 1614, 624, -2668, 3882, -3889, 2686, -647, -1593, 3337, -4043, 3492, -1854, -361, 2463, -3799, 3954, -2878, 907, 1346, -3180, 4025, -3618, 2086, 96, -2247, 3700, -4001, 3058, -1164, -1093, 3009, -3990, 3729, -2309, 170, 2022, -3584, 4032, -3225, 1415, 835, -2826, 3937, -3824, 2521, -434, -1788, 3454, -4045, 3379, -1661, -574, 2630, -3868, 3902, -2723, 697, 1546, -3308, 4041, -3517, 1899, 310, -2422, 3781, -3964, 2914, -957, -1298, 3148, -4020, 3641, -2129, -45, 2205, -3679, 4009, -3091, 1213, 1044, -2975, 3981, -3749, 2350, -221, -1978, 3561, -4036, 3256, -1463, -785, 2789, -3925, 3840, -2561, 485, 1742, -3427, 4046, -3406, 1707, 523, -2591, 3852, -3916, 2761, -747, -1499, 3279, -4039, 3542, -1944, -259, 2381, -3763, 3974, -2949, 1006, 1249, -3116, 4014, -3663, 2172, -6, -2162, 3657, -4015, 3124, -1261, -994, 2940, -3972, 3767, -2391, 271, 1933, -3536, 4039, -3286, 1510, 735}; // ADC采集数据
//   long是32位
long InBufArray[SAMPLE_NODE_NUM] = {0}; // 定义输入数组
long OutBufArray[SAMPLE_NODE_NUM / 2];  // 定义输出数组
long MagBufArray[SAMPLE_NODE_NUM / 2];  // 幅值
u16 MagBufIndex[SAMPLE_NODE_NUM / 2];   // 赋值从大到小的索引
double PhaBufArray[SAMPLE_NODE_NUM / 2];

void _fswap_long(long *a, long *b)
{
    long temp = *a;
    *a = *b;
    *b = temp;
}

void _fswap_u16(u16 *a, u16 *b)
{
    u16 temp = *a;
    *a = *b;
    *b = temp;
}

void _fswap_double(double *a, double *b)
{
    double temp = *a;
    *a = *b;
    *b = temp;
}

void GetSpectrum(void) // 获取频谱
{
    for (int i = 0; i < SAMPLE_NODE_NUM; i++)
    {
        InBufArray[i] = ((signed short)(ADC_Value[i])) << 16;
    }
    cr4_fft_1024_stm32(OutBufArray, InBufArray, SAMPLE_NODE_NUM);
}

void GetPowerMag(void)
{
    signed short lX, lY;
    float X, Y, Mag;
    unsigned short i;
    for (i = 0; i < SAMPLE_NODE_NUM / 2; i++)
    {
        MagBufIndex[i] = i;
        lX = (OutBufArray[i] << 16) >> 16;
        lY = (OutBufArray[i] >> 16);

        // 除以32768再乘65536是为了符合浮点数计算规律
        X = SAMPLE_NODE_NUM * ((float)lX) / 32768;
        Y = SAMPLE_NODE_NUM * ((float)lY) / 32768;
        Mag = sqrt(X * X + Y * Y) / SAMPLE_NODE_NUM;
        if (i == 0)
            MagBufArray[i] = (unsigned long)(Mag * 32768);
        else
            MagBufArray[i] = (unsigned long)(Mag * 65536); // MagBufArray[]为计算输出的幅值数组
    }
}

void GetPowerMagAndPha(void)
{
    signed short lX, lY;
    float X, Y, Mag;
    unsigned short i;
    for (i = 0; i < SAMPLE_NODE_NUM / 2; i++)
    {
        MagBufIndex[i] = i;
        lX = (OutBufArray[i] << 16) >> 16; // REAL
        lY = (OutBufArray[i] >> 16);       // IMAGE
        PhaBufArray[i] = atan2(lX, lY);
        // 除以32768再乘65536是为了符合浮点数计算规律
        X = SAMPLE_NODE_NUM * ((float)lX) / 32768;
        Y = SAMPLE_NODE_NUM * ((float)lY) / 32768;
        Mag = sqrt(X * X + Y * Y) / SAMPLE_NODE_NUM;
        if (i == 0)
            MagBufArray[i] = (unsigned long)(Mag * 32768);
        else
            MagBufArray[i] = (unsigned long)(Mag * 65536); // MagBufArray[]为计算输出的幅值数组
    }
}

void SortSpec(void)
{
    for (int i = 0; i < SAMPLE_NODE_NUM / 2; i++)
    {
        for (int j = i + 1; j < SAMPLE_NODE_NUM / 2; j++)
        {
            if (MagBufArray[i] < MagBufArray[j])
            {
                _fswap_long(&MagBufArray[i], &MagBufArray[j]);
                _fswap_double(&PhaBufArray[i], &PhaBufArray[j]);
                _fswap_u16(&MagBufIndex[i], &MagBufIndex[j]);
            }
        }
    }
}

u16 GetMaxSpec(void)
{
    long mmax = 0;
    u16 index = 0;
    for (int i = 0; i < SAMPLE_NODE_NUM / 2; i++)
    {
        if (mmax < MagBufArray[i])
        {
            mmax = MagBufArray[i];
            index = i;
        }
    }
    return index;
}

double CalcTHD(u16 n)
{
    long t = 0;
    SortSpec();
    for (int i = 1; i < n; i++)
    {
        t += (MagBufArray[i] * MagBufArray[i]);
    }
    return sqrt(t) / (MagBufArray[0] * 1.0);
}
